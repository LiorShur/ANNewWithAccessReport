<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Access Nature - Track accessible trails with GPS">
  <title>Trail Tracker - Access Nature</title>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå≤</text></svg>">
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
  
  <!-- NEW DESIGN SYSTEM (replaces multiple CSS files) -->
  <link rel="stylesheet" href="access-nature-design-system.css">
  
  <!-- Page-Specific Styles -->
  <style>
    /* Tracker-specific overrides and additions */
    body {
      overflow: hidden; /* Prevent scroll on desktop */
      height: 100vh;
      padding-top: 64px; /* Match nav height */
    }

    /* Map Container */
    .map-container {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: var(--z-base);
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Top Control Bar */
    .top-bar {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: var(--space-sm);
      align-items: center;
      background: white;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      z-index: var(--z-fixed);
      flex-wrap: wrap;
    }

    .stat-display {
      font-weight: 600;
      color: var(--text-color);
      font-size: var(--font-size-sm);
      white-space: nowrap;
    }

    .separator {
      color: var(--border-color);
      user-select: none;
    }

    /* Floating Controls */
    .floating-left {
      position: fixed;
      left: var(--space-md);
      top: 140px;
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      z-index: var(--z-fixed);
    }

    .floating-right {
      position: fixed;
      right: var(--space-md);
      top: 140px;
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      z-index: var(--z-fixed);
    }

    /* Compass Container */
    .compass-container {
      position: fixed;
      top: 140px;
      right: var(--space-xl);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
      z-index: var(--z-fixed);
    }

    .compass-display {
      position: relative;
      width: 80px;
      height: 80px;
      background: white;
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-lg);
    }

    .compass-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: var(--radius-full);
      border: 2px solid var(--primary-color);
    }

    .compass-cardinal {
      position: absolute;
      font-size: var(--font-size-xs);
      font-weight: 700;
      color: var(--primary-color);
    }

    .compass-cardinal.north { top: 4px; left: 50%; transform: translateX(-50%); }
    .compass-cardinal.east { right: 4px; top: 50%; transform: translateY(-50%); }
    .compass-cardinal.south { bottom: 4px; left: 50%; transform: translateX(-50%); }
    .compass-cardinal.west { left: 4px; top: 50%; transform: translateY(-50%); }

    .compass-needle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 4px;
      height: 30px;
      background: linear-gradient(to bottom, var(--error-color) 0%, var(--error-color) 50%, #999 50%, #999 100%);
      transform-origin: center 14px;
      transform: translate(-50%, -50%);
      border-radius: 2px;
      transition: transform 0.3s ease;
    }

    .compass-center {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 8px;
      height: 8px;
      background: var(--text-color);
      border-radius: var(--radius-full);
      transform: translate(-50%, -50%);
    }

    .heading-display {
      background: white;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      text-align: center;
    }

    .heading-value {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--primary-color);
    }

    .heading-label {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    /* Recenter Button */
    .recenter-btn {
      position: fixed;
      bottom: calc(80px + var(--space-xl));
      right: var(--space-md);
      width: 48px;
      height: 48px;
      background: white;
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-lg);
      border: none;
      cursor: pointer;
      z-index: var(--z-fixed);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      transition: all var(--transition-fast);
    }

    .recenter-btn:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-xl);
    }

    /* Recording Indicator */
    .recording-indicator {
      position: fixed;
      top: 70px;
      left: var(--space-md);
      background: var(--error-color);
      color: white;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      box-shadow: var(--shadow-lg);
      z-index: var(--z-fixed);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .recording-dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: var(--radius-full);
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .recording-text {
      font-weight: 700;
      font-size: var(--font-size-xs);
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      padding: var(--space-sm);
      z-index: var(--z-fixed);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .nav-button {
      background: none;
      border: none;
      padding: var(--space-sm) var(--space-md);
      cursor: pointer;
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .nav-button:hover {
      background: var(--bg-secondary);
      color: var(--primary-color);
    }

    /* Bottom Popups - CRITICAL Z-INDEX */
    .bottom-popup {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: white;
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      box-shadow: var(--shadow-xl);
      padding: var(--space-xl);
      max-height: 60vh;
      overflow-y: auto;
      z-index: var(--z-modal); /* Higher than nav! */
      transform: translateY(100%);
      transition: transform var(--transition-base);
    }

    .bottom-popup:not(.hidden) {
      transform: translateY(0);
    }

    .bottom-popup h3 {
      margin-bottom: var(--space-lg);
      color: var(--text-color);
    }

    .bottom-popup .btn {
      width: 100%;
      margin-bottom: var(--space-sm);
    }

    /* Accessibility Overlay - CRITICAL Z-INDEX */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal); /* Higher than nav! */
      padding: var(--space-md);
    }

    .overlay.hidden {
      display: none;
    }

    .modal-container {
      background: white;
      border-radius: var(--radius-xl);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: var(--space-xl);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        overflow: visible;
        overflow-x: hidden;
      }

      /* Allow menu to overlay */
      body.menu-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
      }

      /* Lower map z-index when menu open */
      body.menu-open .map-container {
        pointer-events: none;
      }

      body.menu-open .top-bar,
      body.menu-open .floating-left,
      body.menu-open .floating-right,
      body.menu-open .compass-container,
      body.menu-open .bottom-nav {
        pointer-events: none;
      }

      .top-bar {
        top: 70px;
        flex-wrap: wrap;
        max-width: calc(100% - 2rem);
      }

      .floating-left,
      .floating-right {
        top: 120px;
      }

      .compass-container {
        display: none; /* Hide on mobile to save space */
      }

      .bottom-nav {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <a href="#map" class="skip-link">Skip to map</a>

  <!-- Navigation -->
  <nav class="top-nav" role="navigation">
    <a href="index.html" class="nav-brand">
      <span class="nav-brand-icon">üå≤</span>
      <span>Access Nature</span>
    </a>
    
    <button class="menu-toggle" 
            aria-label="Toggle navigation menu"
            aria-expanded="false"
            id="menuToggle">
      <span class="hamburger-icon">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </button>
    
    <div class="nav-menu" id="navMenu">
      <a href="index.html" class="nav-link">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Home</span>
      </a>
      <a href="tracker.html" class="nav-link active">
        <span class="nav-icon">üó∫Ô∏è</span>
        <span class="nav-label">Track Trail</span>
      </a>
      <a href="reports.html" class="nav-link">
        <span class="nav-icon">‚ö†Ô∏è</span>
        <span class="nav-label">Reports</span>
      </a>
      <a href="routes.html" class="nav-link">
        <span class="nav-icon">üìÇ</span>
        <span class="nav-label">My Routes</span>
      </a>
      <a href="accessibility.html" class="nav-link">
        <span class="nav-icon">‚ôø</span>
        <span class="nav-label">Survey</span>
      </a>
      <a href="profile.html" class="nav-link">
        <span class="nav-icon">üë§</span>
        <span class="nav-label">Profile</span>
      </a>
      
      <div class="nav-auth">
        <button id="authBtn" class="btn btn-primary">Sign In</button>
      </div>
    </div>
  </nav>

  <!-- Auth Status Bar (hidden, for backward compatibility) -->
  <div id="authStatusBar" class="auth-status-bar" style="display: none;">
    <div id="userInfo" class="user-info hidden">
      <span class="user-greeting">Welcome, <span id="userEmail"></span>!</span>
      <button id="logoutBtn" class="auth-btn logout-btn">Logout</button>
    </div>
    <div id="authPrompt" class="auth-prompt">
      <button id="showAuthBtn" class="auth-btn login-btn">Sign In</button>
    </div>
  </div>

  <!-- Map Container -->
  <div id="map-container" class="map-container">
    <div id="map"></div>
  </div>

  <!-- Enhanced Compass with Heading Display -->
  <div id="compass-container" class="compass-container">
    <div id="compass" class="compass-display">
      <div class="compass-ring">
        <div class="compass-cardinal north">N</div>
        <div class="compass-cardinal east">E</div>
        <div class="compass-cardinal south">S</div>
        <div class="compass-cardinal west">W</div>
      </div>
      <div id="compass-needle" class="compass-needle"></div>
      <div class="compass-center"></div>
    </div>
    
    <div id="heading-display" class="heading-display">
      <div class="heading-value" id="heading-value">0¬∞</div>
      <div class="heading-label">Heading</div>
    </div>
  </div>

  <!-- Recenter Button -->
  <button id="recenterBtn" class="recenter-btn" title="Center on my location" aria-label="Center on location">
    üìç
  </button>

  <!-- Recording Indicator -->
  <div id="recording-indicator" class="recording-indicator hidden">
    <span class="recording-dot"></span>
    <span class="recording-text">RECORDING</span>
  </div>

  <!-- Top Control Bar -->
  <div class="top-bar">
    <button id="startBtn" class="btn btn-success" title="Start tracking" aria-label="Start tracking">‚ñ∂ Start</button>
    <button id="pauseBtn" class="btn btn-warning" title="Pause tracking" aria-label="Pause tracking">‚è∏ Pause</button>
    <button id="stopBtn" class="btn btn-danger" title="Stop tracking and Save" aria-label="Stop tracking">‚èπ Stop</button>
    <span id="timer" class="stat-display" title="Timer" aria-label="Timer">00:00:00</span>
    <span class="separator">|</span>
    <span id="distance" class="stat-display" title="Distance" aria-label="Distance">0.00 km</span>
  </div>

  <!-- Left Controls -->
  <div class="floating-left">
    <button id="toggleBtn" class="btn btn-icon btn-primary" title="Toggle map rotation" aria-label="Toggle map rotation">üß≠</button>
    <button class="btn btn-icon btn-primary" onclick="openAccessibilityForm()" title="Accessibility form" aria-label="Open accessibility form">‚ôø</button>
  </div>

  <!-- Right Media Panel -->
  <div class="floating-right media-panel" id="mediaPanel">
    <button id="takePhotoBtn" class="btn btn-icon btn-primary" aria-label="Take photo" title="Take Photo">üì∑</button>
    <button class="btn btn-icon btn-primary" onclick="addTextNote()" aria-label="Add note" title="Add Note">üìù</button>
    <button class="btn btn-icon btn-primary" onclick="showRouteDataOnMap()" aria-label="Show Route Data" title="Show Route Data">üó∫</button>
  </div>

  <!-- Bottom Navigation -->
  <div id="bottomNav" class="bottom-nav">
    <button class="nav-button" onclick="togglePanel('exportPanel')">üì§ Export</button>
    <button class="nav-button" onclick="togglePanel('summaryPanel')">üìÇ Routes</button>
    <button class="nav-button" onclick="togglePanel('trailGuidePanel')">üåê Guides</button>
    <button class="nav-button" onclick="togglePanel('devToolsPanel')">üõ†Ô∏è Tools</button>
  </div>

  <!-- Export Panel -->
  <div id="exportPanel" class="bottom-popup hidden">
    <h3>üì§ Export Options</h3>
    <button id="prepareAndExportBtn" class="btn btn-primary">üì¶ Export Route</button>
    <button id="exportGPXBtn" class="btn btn-primary">üìç Export GPX</button>
    <button id="exportPDFBtn" class="btn btn-primary">üìÑ Export PDF</button>
    <button id="exportSummaryBtn" class="btn btn-primary">üåê Export Trail Guide</button>
    <button id="saveToCloudBtn" class="btn btn-success">‚òÅÔ∏è Save to Cloud</button>
  </div>

  <!-- Summary Panel -->
  <div id="summaryPanel" class="bottom-popup hidden">
    <h3>üìÇ My Routes</h3>
    <button id="loadCloudRoutesBtn" class="btn btn-primary">‚òÅÔ∏è Load My Routes</button>
    <button id="loadMyGuidesBtn" class="btn btn-primary">üåê Load My Guides</button>
    <button id="clearAllSessionsBtn" class="btn btn-danger">üóëÔ∏è Clear Routes</button>
    <button id="clearAllAppDataBtn" class="btn btn-danger">üßπ Clear Everything</button>
  </div>

  <!-- Trail Guide Panel -->
  <div id="trailGuidePanel" class="bottom-popup hidden">
    <h3>üåê My Trail Guides</h3>
    <div id="myGuidesList" class="guides-list">
      <!-- Dynamically populated -->
    </div>
  </div>

  <!-- Dev Tools Panel -->
  <div id="devToolsPanel" class="bottom-popup hidden">
    <h3>üõ†Ô∏è Developer Tools</h3>
    <button onclick="showStorageMonitor()" class="btn btn-info">üß™ Storage Monitor</button>
    <button onclick="triggerImport()" class="btn btn-info">üì• Import Route</button>
    <button id="resetBtn" onclick="confirmAndResetApp()" class="btn btn-danger">üîÑ Reset App</button>
  </div>

  <!-- Accessibility Form Modal -->
  <div id="accessibilityOverlay" class="overlay hidden">
    <div id="accessibilityFormContainer" class="modal-container">
      <!-- Dynamically populated by your existing code -->
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Hidden File Inputs -->
  <input type="file" id="photoInput" accept="image/*" capture="environment" class="hidden">
  <input type="file" id="importFile" accept=".json,.gpx" class="hidden">

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Firebase Setup -->
  <script type="module" src="src/firebase-setup.js"></script>

  <!-- Universal Navigation & Auth -->
  <script src="universal-navigation.js"></script>
  <script src="auth-status-handler.js"></script>

  <!-- Load UI helpers -->
  <script src="./src/js/navigation.js"></script>
  <script src="./src/js/toast.js"></script>
  <script src="./src/js/loading.js"></script>
  <script src="./src/js/modal.js"></script>
  
  <script type="module">
    import toast from './src/helpers/toasts.js';
    import modal from './src/helpers/modals.js';
    import { showLoading, hideLoading } from './src/helpers/loading.js';
    
    // Make globally available
    window.toast = toast;
    window.modal = modal;
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
    
    console.log('‚úÖ UI systems loaded');
  </script>

  <!-- Panel Toggle Helper -->
  <script>
    function togglePanel(panelId) {
      // Close all panels first
      document.querySelectorAll('.bottom-popup').forEach(panel => {
        if (panel.id !== panelId) {
          panel.classList.add('hidden');
        }
      });
      
      // Toggle target panel
      const panel = document.getElementById(panelId);
      if (panel) {
        panel.classList.toggle('hidden');
      }
    }

    // Close panels when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.bottom-nav') && !e.target.closest('.bottom-popup')) {
        document.querySelectorAll('.bottom-popup').forEach(panel => {
          panel.classList.add('hidden');
        });
      }
    });
  </script>

  <!-- Your App JavaScript - Keep all your existing functionality! -->
  <script type="module" src="src/main.js"></script>
  <script type="module" src="src/features/auth.js"></script>

</body>
</html>